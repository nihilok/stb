<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stop The Bus!</title>
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
  <script type="text/javascript">
      (function () {
          let css = document.createElement('link');
          css.href = 'https://use.fontawesome.com/releases/v5.15.1/css/all.css';
          css.rel = 'stylesheet';
          css.type = 'text/css';
          document.getElementsByTagName('head')[0].appendChild(css);
      })();
  </script>
</head>
<body class="bg-black">
<div class="container mx-auto min-h-screen py-0 bg-gray-100">

  <div id="mainDiv"
       class="flex flex-col w-full h-full pt-3 justify-start items-center space-y-3">
    <div id="msgConsole" class="w-full justify-center items-center text-center py-3 h-max"
         style="display: none; font-family: monospace; color: #00ff00; background-color: black; position: fixed; bottom: 0%;"></div>
    <div class="flex justify-center items-center text-4xl font-semibold mr-1">Game ID:<span id="gameIdTag"
                                                                                            style="font-family: monospace;"
                                                                                            class="font-bold ml-1">(no game)</span>
    </div>
    <div id="teams" class="grid grid-cols-2 w-full px-5 gap-2 md:w-1/2">
      <div class="flex flex-col justify-start items-center w-full border border-gray-500 rounded bg-white">
        Team A
        <ul id="teamA">

        </ul>
      </div>
      <div class="flex flex-col justify-start items-center w-full border border-gray-500 rounded bg-white">
        Team B
        <ul id="teamB">

        </ul>
      </div>
    </div>
    <div id="timer" class="px-5 md:w-1/2">You will have 30 seconds in which to write as many words beginning with the
      starting
      letter as you can. If your word is the same as a word from the other team, neither word will be counted. Non
      British-English words (including misspelt words) might not be counted. Proper nouns and names ARE counted (within
      reason). The longer the word, the higher the score.
    </div>
    <div class="text-4xl font-semibold">Starting letter: <span id="letter" class="font-bold">?</span></div>
    <div id="gamePanel" class="flex flex-col space-y-3 justify-center items-center w-full" style="display: none">
      <div id="wordList" style="min-height: 10rem;"
           class="mt-2 p-3 w-64 rounded bg-white border-2 border-gray-500 inner-shadow"><span
              class="text-gray-400 italic">words will appear here</span></div>
      <input id="word" name="word" type="text"
             class="w-64 p-2 border-2 border-gray-500 mx-auto rounded inner-shadow text-center text-2xl"
             placeholder="type word here">
      <button onclick="sendWord()">SEND</button>
      <button id='start' class="text-center" style="display: none; margin-bottom: 2rem">
        START
      </button>
    </div>
    <div id="joinCtrls" class="w-full pb-10">
      <div class="flex flex-col space-y-3 justify-center items-center w-full my-5">
        <input id='userName' type="text" placeholder="username" class="border border-black rounded w-64 px-10 py-2">
        <input id='roomName' type="text" placeholder="game id (to join)"
               class="border border-black rounded w-64 px-10 py-2">
        <button id='join'>
          JOIN GAME
        </button>

        <button id="newRoomBtn">NEW GAME</button>
      </div>
    </div>
    <div class="h-full"></div>
    <div class="flex space-x-2 justify-center items-center px-3 w-full border-t border-gray-400 inner-shadow">
      <div>Players:</div><div id="playersInGame">**no game**</div></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>
<!--<script type="text/javascript" src="{{ url_for('static', filename='js/index.js') }}"></script>-->

<script type="text/javascript">
    // Socket connection:
    socketio = io(`${window.origin}`);


    // DOM elements:

    let msgConsole = document.getElementById('msgConsole');
    let gameId = document.getElementById('gameIdTag')
    let gamePanel = document.getElementById('gamePanel')
    let startBtn = document.getElementById('start')
    let teamA = document.getElementById('teamA');
    let teamB = document.getElementById('teamB');
    let roomName = document.getElementById('roomName');
    let userName = document.getElementById('userName');
    let joinBtn = document.getElementById('join');
    let word = document.getElementById('word');
    let wordList = document.getElementById('wordList');
    let newRoomBtn = document.getElementById('newRoomBtn');
    let timer = document.getElementById("timer")
    let playersInGame = document.getElementById("playersInGame")

    // Socket funcs:

    const newRoom = () => {
        checkUsername('new_room', null);
    };

    const joinGame = () => {
        checkUsername('join', roomName.value);
    };

    const sendWord = () => {
        socketio.emit('send_word_to_room', {word: word.value, room: gameId.innerText, user: getUserIdCookie()});
        word.value = '';
    };

    const startGame = () => {
        socketio.emit('start_game', {room: gameId.innerText});
    };


    // Other funcs:

    const onEnter = (e, func) => {
        if (e.key === 'Enter') {
            console.log('Enter key pressed')
            func();
        }
    }

    const checkUsername = (socketEvent, room) => {
        if (userName.value) {
            socketio.emit(socketEvent, {username: userName.value, userID: getUserIdCookie(), room: room});
            userName.classList.remove('border', 'border-2', 'border-red-500');
            return;
        }
        flashMessage('You need a username...')
        userName.classList.add('border', 'border-2', 'border-red-500');
        userName.focus()
    }

    const getUserIdCookie = () => {
        return document.cookie
            .split('; ')
            .find(row => row.startsWith('userID='))
            .split('=')[1];
    };

    const loopTeam = (team, teamDiv) => {
        teamDiv.innerHTML = '';
        for (i = 0; i < team.length; i++) {
            let li = document.createElement('li');
            li.innerHTML = team[i];
            teamDiv.appendChild(li);
        }
    };

    const convertDateForIos = (date) => {
        let arr = date.split(/[- :]/);
        date = new Date(arr[0], arr[1] - 1, arr[2], arr[3], arr[4], arr[5]);
        return date;
    }

    const flashMessage = (message) => {
        msgConsole.style.display = 'flex';
        msgConsole.innerHTML = message;
        msgConsole.scrollIntoView(true);
        setTimeout(() => {
            msgConsole.innerHTML = '';
            msgConsole.style.display = 'none';
        }, 3000);
    }


    // Socketio event handling:

    socketio.on('connect', () => {
        console.log('Connected');
    });

    socketio.on('disconnect', () => {
        console.log('Disconnected');
    });

    socketio.on('message', (msg) => {
        flashMessage(msg);
    });

    socketio.on('player_joined', (msg) => {
        flashMessage(msg)
    });

    socketio.on('update_joined_players', (players) => {
        playersInGame.innerHTML = players
    })

    socketio.on('new_room_name', (data) => {
        gameId.innerHTML = data;
        let joinCtrls = document.getElementById('joinCtrls');
        joinCtrls.style.display = 'none';
        startBtn.style.display = 'block';
        gamePanel.style.display = 'flex';
    });

    socketio.on('game_started', (data) => {
        loopTeam(data.a, teamA);
        loopTeam(data.b, teamB);
        wordList.innerHTML = '';
        startBtn.style.display = 'none';
    });

    socketio.on('starting_letter', (letter) => {
        document.getElementById('letter').innerHTML = letter;
    });

    socketio.on('receive_word', (msg) => {
        console.log('team words: ' + msg);
        wordList.innerHTML = msg;
    });

    socketio.on('round_result', (data) => {
        wordList.innerHTML = '';
        wordList.innerHTML += `Team A <br> WORDS: ${data.a['good_words'] ? data.a['good_words'] : 'None'}<br>NOT COUNTED: ${data.a['bad_words'] ? data.a['bad_words'] : 'None'}<br>SCORE: ${data.a['score']}`;
        wordList.innerHTML += `<br><br>Team B <br> WORDS: ${data.b['good_words'] ? data.b['good_words'] : 'None'}<br>NOT COUNTED: ${data.b['bad_words'] ? data.b['bad_words'] : 'None'}<br>SCORE: ${data.b['score']}`;
        wordList.innerHTML += `<br><br>COMMON WORDS: ${data.common_words}`;
        wordList.innerHTML += `<br><br>${data.winner}`;
        wordList.innerHTML += `<br>${data.score_tally}`;
        startBtn.style.display = 'block';
    });

    socketio.on('start_timer', (time) => {
        timer.classList.add('text-2xl', 'font-bold', 'text-center', 'text-red-500')
        timer.innerHTML = 'GO!'
        const countDownDate = convertDateForIos(time).getTime();
        const x = setInterval(function () {
            let now = new Date().getTime();
            let distance = countDownDate - now;
            let seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timer.innerHTML = seconds + "s remaining";
            if (distance < 0) {
                clearInterval(x);
                timer.innerHTML = "TIME'S UP!";
                if (getUserIdCookie() === gameIdTag.innerHTML) {
                    socketio.emit('time_up', gameIdTag.innerHTML)
                }
            }
        }, 1000);
    });


    // DOM event handling:

    startBtn.addEventListener('click', startGame)

    newRoomBtn.addEventListener('click', newRoom)

    joinBtn.addEventListener('click', joinGame)

    roomName.addEventListener('keyup', (e) => {
        onEnter(e, joinGame);
    });

    userName.addEventListener('keyup', (e) => {
        onEnter(e, () => {
            if (roomName.value) {
                joinGame();
            } else {
                newRoom();
            }
        });
    });

    word.addEventListener('keyup', (e) => {
        onEnter(e, sendWord);
    });

</script>
</body>
</html>